# 主从同步原理

主从复制主要有三个线程: master(bing log dump), slaver(I/O thread, SQL thread)

主从复制的基础是主库数据变更都会记录到`bing log`中.

1. 当 **bing log** 有变动的时候, `log dump线程` 会读取其内容发送给从节点.
2. 从节点 `I/O线程` 会接收到 **bing log** 内容后, 会将其记录到 **relay log** 文件中.
3. 从节点的 `SQL线程` 读取 **relay log** 内容并进行重放, 最终保证数据的一致性.

## 异常情况

由于同步是异步的, 主库发送完数据后不会关心从库的数据是否已经处理, 假如主库宕机, 从库处理失败了, 此时从库升到主库后, 会导致日志丢失.

### 全同步复制

主库 bing log 同步到从库后, 所有的从库执行完成后才返给客户端, 性能影响严重.

### 半同步复制

从库写入日志成功后返回ACK给主库, 主库收到至少一个应答后认为写操作完成.
